import { useState } from 'react'

/**
 * Payment Form Component - ูููู ูููุฐุฌ ุงูุฏูุน
 */
export default function PaymentForm({ 
  totalAmount, 
  onPaymentSubmit, 
  isProcessing,
  selectedPaymentMethod,
  onPaymentMethodChange 
}) {
  const [paymentData, setPaymentData] = useState({
    // ุจูุงูุงุช ููุฏุงููู ูุงุด
    vodafone_phone: '',
    
    // ุจูุงูุงุช InstaPay
    instapay_account: '',
    
    // ุจูุงูุงุช ุงูุจุทุงูุฉ ุงูุจูููุฉ
    card_number: '',
    card_holder: '',
    expiry_date: '',
    cvv: ''
  })

  const [errors, setErrors] = useState({})

  const handleInputChange = (e) => {
    const { name, value } = e.target
    setPaymentData(prev => ({ ...prev, [name]: value }))
    
    // ุฅุฒุงูุฉ ุงูุฎุทุฃ ุนูุฏ ุงูุชุนุฏูู
    if (errors[name]) {
      setErrors(prev => ({ ...prev, [name]: '' }))
    }
  }

  const validatePaymentData = () => {
    const newErrors = {}

    if (selectedPaymentMethod === 'vodafone') {
      if (!paymentData.vodafone_phone) {
        newErrors.vodafone_phone = 'ุฑูู ููุฏุงููู ูุทููุจ'
      } else if (!/^01[0125]\d{8}$/.test(paymentData.vodafone_phone)) {
        newErrors.vodafone_phone = 'ุฑูู ููุฏุงููู ุบูุฑ ุตุญูุญ'
      }
    }

    if (selectedPaymentMethod === 'instapay') {
      if (!paymentData.instapay_account) {
        newErrors.instapay_account = 'ุญุณุงุจ InstaPay ูุทููุจ'
      }
    }

    if (selectedPaymentMethod === 'bank') {
      if (!paymentData.card_number) {
        newErrors.card_number = 'ุฑูู ุงูุจุทุงูุฉ ูุทููุจ'
      } else if (!/^\d{16}$/.test(paymentData.card_number.replace(/\s/g, ''))) {
        newErrors.card_number = 'ุฑูู ุงูุจุทุงูุฉ ูุฌุจ ุฃู ูููู 16 ุฑูู'
      }

      if (!paymentData.card_holder) {
        newErrors.card_holder = 'ุงุณู ุญุงูู ุงูุจุทุงูุฉ ูุทููุจ'
      }

      if (!paymentData.expiry_date) {
        newErrors.expiry_date = 'ุชุงุฑูุฎ ุงูุชูุงุก ุงูุจุทุงูุฉ ูุทููุจ'
      } else if (!/^(0[1-9]|1[0-2])\/\d{2}$/.test(paymentData.expiry_date)) {
        newErrors.expiry_date = 'ุตูุบุฉ ุงูุชุงุฑูุฎ ูุฌุจ ุฃู ุชููู MM/YY'
      }

      if (!paymentData.cvv) {
        newErrors.cvv = 'CVV ูุทููุจ'
      } else if (!/^\d{3,4}$/.test(paymentData.cvv)) {
        newErrors.cvv = 'CVV ูุฌุจ ุฃู ูููู 3 ุฃู 4 ุฃุฑูุงู'
      }
    }

    setErrors(newErrors)
    return Object.keys(newErrors).length === 0
  }

  const handleSubmit = (e) => {
    e.preventDefault()
    
    if (selectedPaymentMethod === 'cash') {
      onPaymentSubmit({ payment_method: 'cash' })
      return
    }

    if (!validatePaymentData()) {
      return
    }

    const paymentInfo = {
      payment_method: selectedPaymentMethod,
      payment_data: paymentData
    }

    onPaymentSubmit(paymentInfo)
  }

  const formatCardNumber = (value) => {
    // ุฅุฒุงูุฉ ูู ุดูุก ุนุฏุง ุงูุฃุฑูุงู
    const numbers = value.replace(/\D/g, '')
    // ุฅุถุงูุฉ ูุณุงูุงุช ูู 4 ุฃุฑูุงู
    return numbers.replace(/(\d{4})(?=\d)/g, '$1 ')
  }

  const formatExpiryDate = (value) => {
    // ุฅุฒุงูุฉ ูู ุดูุก ุนุฏุง ุงูุฃุฑูุงู
    const numbers = value.replace(/\D/g, '')
    // ุฅุถุงูุฉ / ุจุนุฏ ุงูุดูุฑ
    if (numbers.length >= 2) {
      return numbers.slice(0, 2) + '/' + numbers.slice(2, 4)
    }
    return numbers
  }

  const getPaymentMethodIcon = (method) => {
    const icons = {
      cash: '๐ต',
      vodafone: '๐ฑ',
      instapay: '๐ณ',
      bank: '๐ฆ'
    }
    return icons[method] || '๐ฐ'
  }

  const getPaymentInstructions = () => {
    switch (selectedPaymentMethod) {
      case 'cash':
        return {
          title: 'ุงูุฏูุน ุนูุฏ ุงูุงุณุชูุงู',
          instructions: [
            'ุณุชููู ุจุฏูุน ุงููุจูุบ ุนูุฏ ูุตูู ุงูุทูุจ',
            'ุชุฃูุฏ ูู ูุฌูุฏ ุงููุจูุบ ูุงููุงู',
            'ุงููุจูุบ ุงููุทููุจ: ' + totalAmount + ' ุฌููู'
          ]
        }
      
      case 'vodafone':
        return {
          title: 'ุงูุฏูุน ุนุจุฑ ููุฏุงููู ูุงุด',
          instructions: [
            'ุงุชุตู *9# ูู ูุงุชูู ููุฏุงููู',
            'ุงุฎุชุฑ "ุชุญููู ูููุณ" โ "ูุฑูู ููุฏุงููู ูุงุด"',
            'ุงุฏุฎู ุฑูู ุงููุญูุธุฉ ุงูุชุฌุงุฑูุฉ ุงูุฐู ุณูุธูุฑ ูู',
            'ุงุฏุฎู ุงููุจูุบ: ' + totalAmount + ' ุฌููู',
            'ุงุฏุฎู ุงูุฑูุฒ ุงููุฑุฌุนู ุงูุฐู ุณูุชู ุฅุฑุณุงูู ูู'
          ]
        }
      
      case 'instapay':
        return {
          title: 'ุงูุฏูุน ุนุจุฑ InstaPay',
          instructions: [
            'ุงูุชุญ ุชุทุจูู InstaPay',
            'ุงุฎุชุฑ "ุชุญููู ูููุณ"',
            'ุงุฏุฎู ุญุณุงุจ ุงููุทุนู ุงูุฐู ุณูุธูุฑ ูู',
            'ุงุฏุฎู ุงููุจูุบ: ' + totalAmount + ' ุฌููู',
            'ุงุฏุฎู ุงูุฑูุฒ ุงููุฑุฌุนู'
          ]
        }
      
      case 'bank':
        return {
          title: 'ุงูุฏูุน ุจุงูุจุทุงูุฉ ุงูุจูููุฉ',
          instructions: [
            'ุงุฏุฎู ุจูุงูุงุช ุงูุจุทุงูุฉ ุจุฏูุฉ',
            'ุชุฃูุฏ ูู ุตุญุฉ ุชุงุฑูุฎ ุงูุชูุงุก ุงูุจุทุงูุฉ',
            'ุงุฏุฎู ุฑูุฒ CVV ูู ุฎูู ุงูุจุทุงูุฉ',
            'ุณูุชู ุฎุตู ุงููุจูุบ: ' + totalAmount + ' ุฌููู'
          ]
        }
      
      default:
        return { title: '', instructions: [] }
    }
  }

  const instructions = getPaymentInstructions()

  return (
    <div style={{
      border: '2px solid #e2e8f0',
      borderRadius: '10px',
      padding: '20px',
      backgroundColor: '#f8fafc',
      marginTop: '20px'
    }}>
      <div style={{
        display: 'flex',
        alignItems: 'center',
        gap: '10px',
        marginBottom: '20px',
        fontSize: '18px',
        fontWeight: 'bold',
        color: '#1e293b'
      }}>
        ๐ฐ ุชูุงุตูู ุงูุฏูุน
      </div>

      {/* Payment Method Selection */}
      <div style={{ marginBottom: '20px' }}>
        <div style={{ fontWeight: 'bold', marginBottom: '10px' }}>ุทุฑููุฉ ุงูุฏูุน</div>
        <div style={{ display: 'flex', flexWrap: 'wrap', gap: '12px' }}>
          {[
            { value: 'cash', label: 'ุงูุฏูุน ุนูุฏ ุงูุงุณุชูุงู ๐ต' },
            { value: 'vodafone', label: 'ููุฏุงููู ูุงุด ๐ฑ' },
            { value: 'instapay', label: 'InstaPay ๐ณ' },
            { value: 'bank', label: 'ุจุทุงูุฉ ุจูููุฉ ๐ฆ' }
          ].map(method => (
            <label 
              key={method.value}
              style={{
                display: 'flex',
                alignItems: 'center',
                gap: '8px',
                padding: '10px 15px',
                border: selectedPaymentMethod === method.value ? '2px solid #059669' : '2px solid #e2e8f0',
                borderRadius: '8px',
                backgroundColor: selectedPaymentMethod === method.value ? '#dcfce7' : 'white',
                cursor: 'pointer',
                transition: 'all 0.2s'
              }}
            >
              <input 
                type="radio" 
                name="paymentMethod" 
                value={method.value}
                checked={selectedPaymentMethod === method.value}
                onChange={onPaymentMethodChange}
                style={{ marginRight: '5px' }}
              />
              {method.label}
            </label>
          ))}
        </div>
      </div>

      {/* Payment Instructions */}
      {instructions.title && (
        <div style={{
          backgroundColor: '#dbeafe',
          border: '1px solid #93c5fd',
          borderRadius: '8px',
          padding: '15px',
          marginBottom: '20px'
        }}>
          <div style={{ fontWeight: 'bold', color: '#1d4ed8', marginBottom: '8px' }}>
            {getPaymentMethodIcon(selectedPaymentMethod)} {instructions.title}
          </div>
          <ul style={{ margin: 0, paddingLeft: '20px', color: '#1e40af' }}>
            {instructions.instructions.map((instruction, index) => (
              <li key={index} style={{ marginBottom: '4px' }}>{instruction}</li>
            ))}
          </ul>
        </div>
      )}

      {/* Payment Form Fields */}
      <form onSubmit={handleSubmit}>
        {selectedPaymentMethod === 'vodafone' && (
          <div style={{ marginBottom: '15px' }}>
            <label style={{ display: 'block', marginBottom: '5px', fontWeight: 'bold' }}>
              ุฑูู ููุฏุงููู ูุงุด
            </label>
            <input
              type="tel"
              name="vodafone_phone"
              value={paymentData.vodafone_phone}
              onChange={handleInputChange}
              placeholder="01xxxxxxxxx"
              style={{
                width: '100%',
                padding: '12px',
                border: errors.vodafone_phone ? '2px solid #ef4444' : '2px solid #e2e8f0',
                borderRadius: '8px',
                fontSize: '16px'
              }}
            />
            {errors.vodafone_phone && (
              <div style={{ color: '#ef4444', fontSize: '14px', marginTop: '5px' }}>
                {errors.vodafone_phone}
              </div>
            )}
          </div>
        )}

        {selectedPaymentMethod === 'instapay' && (
          <div style={{ marginBottom: '15px' }}>
            <label style={{ display: 'block', marginBottom: '5px', fontWeight: 'bold' }}>
              ุญุณุงุจ InstaPay
            </label>
            <input
              type="text"
              name="instapay_account"
              value={paymentData.instapay_account}
              onChange={handleInputChange}
              placeholder="@username ุฃู ุฑูู ุงูููุจุงูู"
              style={{
                width: '100%',
                padding: '12px',
                border: errors.instapay_account ? '2px solid #ef4444' : '2px solid #e2e8f0',
                borderRadius: '8px',
                fontSize: '16px'
              }}
            />
            {errors.instapay_account && (
              <div style={{ color: '#ef4444', fontSize: '14px', marginTop: '5px' }}>
                {errors.instapay_account}
              </div>
            )}
          </div>
        )}

        {selectedPaymentMethod === 'bank' && (
          <div style={{ display: 'grid', gap: '15px' }}>
            <div>
              <label style={{ display: 'block', marginBottom: '5px', fontWeight: 'bold' }}>
                ุฑูู ุงูุจุทุงูุฉ
              </label>
              <input
                type="text"
                name="card_number"
                value={formatCardNumber(paymentData.card_number)}
                onChange={(e) => handleInputChange({
                  target: { 
                    name: 'card_number', 
                    value: e.target.value.replace(/\s/g, '') 
                  }
                })}
                placeholder="1234 5678 9012 3456"
                maxLength="19"
                style={{
                  width: '100%',
                  padding: '12px',
                  border: errors.card_number ? '2px solid #ef4444' : '2px solid #e2e8f0',
                  borderRadius: '8px',
                  fontSize: '16px'
                }}
              />
              {errors.card_number && (
                <div style={{ color: '#ef4444', fontSize: '14px', marginTop: '5px' }}>
                  {errors.card_number}
                </div>
              )}
            </div>

            <div>
              <label style={{ display: 'block', marginBottom: '5px', fontWeight: 'bold' }}>
                ุงุณู ุญุงูู ุงูุจุทุงูุฉ
              </label>
              <input
                type="text"
                name="card_holder"
                value={paymentData.card_holder}
                onChange={handleInputChange}
                placeholder="ุงูุงุณู ููุง ูู ููุชูุจ ุนูู ุงูุจุทุงูุฉ"
                style={{
                  width: '100%',
                  padding: '12px',
                  border: errors.card_holder ? '2px solid #ef4444' : '2px solid #e2e8f0',
                  borderRadius: '8px',
                  fontSize: '16px'
                }}
              />
              {errors.card_holder && (
                <div style={{ color: '#ef4444', fontSize: '14px', marginTop: '5px' }}>
                  {errors.card_holder}
                </div>
              )}
            </div>

            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '15px' }}>
              <div>
                <label style={{ display: 'block', marginBottom: '5px', fontWeight: 'bold' }}>
                  ุชุงุฑูุฎ ุงูุชูุงุก ุงูุจุทุงูุฉ
                </label>
                <input
                  type="text"
                  name="expiry_date"
                  value={formatExpiryDate(paymentData.expiry_date)}
                  onChange={(e) => handleInputChange({
                    target: { 
                      name: 'expiry_date', 
                      value: e.target.value.replace(/\D/g, '') 
                    }
                  })}
                  placeholder="MM/YY"
                  maxLength="5"
                  style={{
                    width: '100%',
                    padding: '12px',
                    border: errors.expiry_date ? '2px solid #ef4444' : '2px solid #e2e8f0',
                    borderRadius: '8px',
                    fontSize: '16px'
                  }}
                />
                {errors.expiry_date && (
                  <div style={{ color: '#ef4444', fontSize: '14px', marginTop: '5px' }}>
                    {errors.expiry_date}
                  </div>
                )}
              </div>

              <div>
                <label style={{ display: 'block', marginBottom: '5px', fontWeight: 'bold' }}>
                  CVV
                </label>
                <input
                  type="text"
                  name="cvv"
                  value={paymentData.cvv}
                  onChange={handleInputChange}
                  placeholder="123"
                  maxLength="4"
                  style={{
                    width: '100%',
                    padding: '12px',
                    border: errors.cvv ? '2px solid #ef4444' : '2px solid #e2e8f0',
                    borderRadius: '8px',
                    fontSize: '16px'
                  }}
                />
                {errors.cvv && (
                  <div style={{ color: '#ef4444', fontSize: '14px', marginTop: '5px' }}>
                    {errors.cvv}
                  </div>
                )}
              </div>
            </div>
          </div>
        )}

        {/* Total Amount Display */}
        <div style={{
          backgroundColor: '#dcfce7',
          border: '2px solid #16a34a',
          borderRadius: '8px',
          padding: '15px',
          marginTop: '20px',
          textAlign: 'center'
        }}>
          <div style={{ fontSize: '18px', fontWeight: 'bold', color: '#15803d' }}>
            ุงููุจูุบ ุงูุฅุฌูุงูู: {totalAmount} ุฌููู
          </div>
        </div>

        {/* Submit Button */}
        <button
          type="submit"
          disabled={isProcessing}
          style={{
            width: '100%',
            padding: '15px',
            backgroundColor: isProcessing ? '#9ca3af' : '#059669',
            color: 'white',
            border: 'none',
            borderRadius: '8px',
            fontSize: '18px',
            fontWeight: 'bold',
            cursor: isProcessing ? 'not-allowed' : 'pointer',
            marginTop: '20px',
            transition: 'background-color 0.2s'
          }}
        >
          {isProcessing ? (
            <>โณ ุฌุงุฑู ุงููุนุงูุฌุฉ...</>
          ) : (
            <>๐ฐ ุชุฃููุฏ ุงูุฏูุน</>
          )}
        </button>
      </form>
    </div>
  )
}